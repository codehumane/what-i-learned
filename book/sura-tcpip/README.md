
# TCP/IP 쉽게, 더 쉽게

가볍게 보고 있는데 생각보다 재밌어서 간단히 기록까지.

# CH3. 트랜스포트 계층

- 인터넷 계층이 컴퓨터까지 데이터를 전달했다면,
- 트랜스포트 계층은 컴퓨터로 들어온 데이터를 애플리케이션 계층으로 전달.
- 이 때 애플리케이션 식별은 포트 번호로.
- 포트 번호를 웰노운, 레지스터드, 다이나믹으로 나누어 설명.
- TCP의 경우 데이터 전송의 신뢰성을 위해,
- 데이터를 세그먼트 단위로 분할하고 전송 속도를 조정하며 필요시 재전송도.
- TCP 세그먼트는 데이터 본체에 더해 TCP 헤더가 붙음.
- 송신지 포트 번호, 수신지 포트 번호, 일련번호, 확인 응답 번호, 컨트롤 비트 등이 헤더에 포함.
- 커넥션을 맺는 과정은 3-way 핸드쉐이크이며 순서는 SYN(C) - ACK/SYN(S) - ACK(C)).
- 커넥션을 끊을 때는 FIN(C) - ACK(S) - FIN(S) - ACK(C).

![TCP 커넥션 다이어그램](https://farm1.staticflickr.com/440/18338404268_f693b065d4_o.png)

- 데이터 전송 과정에서 일련번호와 확인 응답 번호가 어떻게 바뀌는지도 소개.
- `일련번호의 최종값 - 1`은 송신 바이트 수이고 `확인 응답 번호 - 1`은 수신한 바이트 수.
- 응답을 기다리는 대신 연속으로 데이터를 몰아서 보내고 응답도 몰아서 받는 식으로 속도를 높이기도.
- 이렇게 연속으로 데이터를 주고 받을 때, TCP 헤더인 윈도우 사이즈에 가용한 버퍼를 송신 측에 통보.
- 이 버퍼에 맞게 송신 측은 흐름 제어를 하며 요청량을 조절함.
- 한편, UDP는 이런 별다른 처리가 없는 대신 빠름.
- 더불어 브로드캐스트와 멀티캐스트도 가능.
- 때로는 UDP에 부족한 흐름 제어나 혼잡 제어 기능을 애플리케이션 차원에서 구현하기도.

# CH4. 라우팅과 인터넷 계층

- 네트워크 인터페이스 계층과 협력하여,
- 송신지 컴퓨터의 데이터를 수신지 컴퓨터까지 전달함.

## IP

- 수신지 컴퓨터 식별에는 IP 어드레스가 사용됨.
- 보통 전화번호나 우편번호와 비교되곤 하는데,
- IP는 지리 정보가 아니라 소속 네트워크를 알려준다는 점이 다름.
- 라우터는 이런 네트워크들의 연결 정보를 관리하고 연결시켜줌.
- IP 어드레스 고갈 방지 대안으로 private, public 어드레스 언급.
- IPv4, IPv6, DNS 이야기도 잠깐 함.
- IPv4에서는 헤더에 TTL을 이용해서, IPv6는 홉 리미트를 이용해서 IP 패킷의 유통기한을 관리.
- 이 유통기한이 다 지나면 패킷을 소멸시켜, 네트워크를 계속 떠돌아다니며 혼잡하게 만드는 것을 방지.
- 통신 경로 상태에 따라 라우터가 MTU<sup>Maximum Transmission Unit</sup>를 보고 패킷을 분할해서 전송하기도.
- 참고로 IPv6는 애당초 라우터에서 데이터를 분할하지 않는 방식으로 사양이 만들어져 있으며 관련 필드는 선택적임.
- IP 어드레스(예컨대 192.168.1.100)는 네트워크 부(192.168.1)와 호스트 부(100)로 구성.
- 라우터는 네트워크 부를 보고 목적지가 같은 네트워크인지 여부를 판단.
- 이렇게 네트워크 부와 호스트 부를 구분할 때, 길이를 미리 정해 놓는 어드레스 클래스와, 길이를 유연하게 조정할 수 있는 서브넷 마스크 방식 존재.
- 참고로, C 클래스에서 서브넷 마스크를 쓰게 되면, 8비트 내에서 할당할 수 있는 호스트의 수가 적으므로, 일반적으로는 A나 B어드레스 세분화에 활용.

## 라우터

- 라우터의 역할은 네트워크 간의 패킷을 전달하는 것.
- 이런 라우터를 거쳐가며 최종 목적지까지 도달하는 것을 라우팅이라 함.
- 라우터는 내부에 저장하고 있는 라우팅 테이블을 이용해 라우팅 진행.
- 라우팅에는 정적 라우팅과 동적 라우팅이 있음.
- 정적 라우팅은 네트워크 관리자가 직접 수작업으로 라우팅 테이블을 설정.
- 동적 라우팅은 라우팅 프로토콜을 이용해 자동으로 경로 정보 수집 후 라우팅 테이블 설정.
- 네트워크의 수가 너무 많으므로 라우팅 테이블에 목적지 정보가 없을 수 있으며 이럴 땐 디폴트 라우터에게 물어보게 됨.
- 이 디폴트 라우터 정보가 바로 정적으로 설정되어 있음.

| 목적지 | 전달할 곳 |
| ----- | ------- |
| 64.X.0.0/24 | 라우터 3의 어드레스 |
| 23.X.0.0/24 | 라우터 2의 어드레스 |
| 118.X.0.0/24 | 라우터 1의 어드레스 |

- 동적 라우팅 알고리즘에는 거리 벡터형과 링크 상태형이 존재.
- 거리 벡터형은 목적지까지의 거리(경유하는 라우터의 수인 홉을 사용)를 계산해서 가장 적은 수의 경로를 선택.
- 링크 상태형은 네트워크의 통신 상태 정보를 맵으로 관리하면서 상태가 가장 좋은 경로를 선택. 복잡하고 변화가 잦은 네트워크에 사용.
- 규모 있는 네트워크에서는 몇 개의 네트워크를 하나로 묶어 AS(자율시스템<sup>Autonomous System</sup>) 단위로 관리하기도 함.
- 작은 라우터를 여러 번 거치는 대신 이렇게 큰 단위씩 이동하면 더 빠른 라우팅이 가능.
- AS 간에는 경로 벡터형인 BGP<sup>Border Gateway Protocol</sup>을, AS 안에서는 링크 상태형인 OSPF<sup>Open Shortest Path First</sup>를 사용한다고 함.

## ICMP

- ICMP<sup>Internet Control Message Protocol</sup> 프로토콜은 데이터 전송 중 장애 상황을 통보하는 데 사용.
- 예컨대, 패킷이 TTL 경과로 네트워크 상에서 소멸될 때 라우터가 송신 측으로 타입 11 ICMP 메시지를 보냄.
- 또한, 네트워크에 속한 라우터의 IP 어드레스를 알고 싶을 땐 타입 9와 10을 사용.

| 타입 | 의미 |
| --- | --- |
| 8   | 에코 요청. 수신 측 장비가 존재하는지 확인 |
| 0   | 에코 응답. 수신 측 장비가 존재함을 알림 |
| 3   | 데이터가 도착하지 않음 |
| 4   | 회선 상태 복잡 |
| 5   | 경로 상태가 최적이 아님 |
| 10  | 장비가 네트워크에 새로 연결됐을 때 라우터를 찾기 위해 사용 |
| 9   | 라우터가 10번에 대한 응답으로 사용 |
| 11  | 생존 기간이 지난 패킷을 삭제했음 |

## 어드레스 변환

- 프라이빗 IP를 사용하는 서버로 통신하기 위해 NAT<sup>Network Address Translation</sup> 사용됨.
- 절차는 아래 그림 참고.

![](https://upload.wikimedia.org/wikipedia/commons/6/63/Network_Address_Translation_%28file2%29.jpg)

- 참고로, NAT는 IPv4와 IPv6와의 변환에도 응용됨.
- 그런데 만약 내부의 여러 호스트가 같은 포트를 사용한다면,
- 라우터는 이 중 어느 곳으로 응답을 돌려줘야 할지 판단이 어려움.
- 더불어, (당연하게도) 외부에서 일방적으로 보낸 데이터는 NAT 범위 안 호스트로 전달 불가.
- NAT의 포트 충돌을 막기 위해 NAPT<sup>Network Address Port Translation</sup>를 사용.
- 이는 IP 뿐만 아니라 포트 번호도 함께 변환.
- 한편, 외부에서 들어오는 데이터 전달을 위해서는 포트 포워딩을 이용.
- 라우터의 특정 포트로 요청이 들어오면 정해진 서버로 전달해 주는 것.

## 도메인명

- IP에 대응하는 가독성있는 주소.
- `www.sample.co.kr`에서 `www`가 호스트고 `sample.co.kr`이 도메인인데,
- `www.sample.co.kr` 전체를 도메인이라고 부르기도 함.
- 도메인에 대응하는 IP 주소를 얻으려면 DNS 서버에게 질의.
- 이를 위해, 컴퓨터나 라우터에는 미리 DNS 서버 IP를 알고 있어야 함.
- DNS는 루트 네임 서버 밑에 각자 자신의 도메인을 담당하는 DNS 컨텐츠 서버를 계층 형태로 두고 있음.

```
           루트 네임 서버 (하위 계층의 DNS 서버 정보를 알고 있음)
           /        \
KR 관리 DNS 서버     UK 관리 DNS 서버
  /  |  \
ISP 등에서 관리하는 DNS 서버
```

- DNS 서버는 크게 2가지로 분류할 수 있음.
- 도메인명을 관리하는 컨텐츠 서버, 질의에 응답하기 위한 캐시 서버.
- 아래 그림은 DNS 서버 질의 처리 절차([전체 내용은 여기](https://medium.com/@openmohan/dns-basics-and-building-simple-dns-server-in-go-6cb8e1cfe461)).

![](https://miro.medium.com/max/1400/1*20lOJctutX1PTdWzYUbbZQ.png)

## DHCP

- 네트워크에 속한 호스트들은 서로 IP가 중복되지 않아야 함.
- 이 작업을 사람 대신 자동으로 해 주는 것이 DHCP<sup>Dynamic Host Configuration Protocol</sup>.
- DHCP로 IP가 할당되는 과정을 아래와 같음.
  - 네트워크에 새로운 호스트가 등장.
  - 이 호스트는 IP가 할당되지도 않았고, 호스트엔 DHCP 서버의 IP 정보도 없음.
  - 그래서 새로운 호스트는 네트워크의 모든 호스트에게 `DHCP 발견 메시지`를 브로드캐스팅.
  - 이 메시지를 받은 DHCP 서버는 사용 가능한 IP를 모든 호스트에게 브로드캐스팅.
  - 새로운 호스트의 주소가 아직 할당되지 않았으므로 DHCP 서버 역시 신규 호스트를 찾을 수 없기 때문.

## IP 관련 명령어

- ipconfig
  - 컴퓨터에 할당된 IP 어드레스나 서브넷 마스크 등의 정보를 확인.
- ping
  - 지정한 IP로 ICMP 타입 8번 메시지를 보내는 것.
  - 이는 에코를 요청하는 것으로, 수신자가 자신이 받은 메시지를 송신자에게 다시 되돌려 보내라는 의미.
  - 이를 통해 상대방이 통신 가능한 상태인지 확인할 수 있음.
- tracert
  - 인터넷에서 라우터와 라우터의 연결을 따라 전달되는 데이터 경로를 표시.
  - 리눅스에서는 traceroute.
  - ping과 마찬가지로 ICMP 타입 8번에 해당하는 에코 요청을 보내는 것.
  - 그런데 이 때 IP 헤더의 생존 기간을 1에서 시작해서 1씩 증가시키며 여러 번 보내게 됨.
  - TTL이 경과하면 라우터에서 ICMP 타입 11번에 해당하는 시간 초과 메시지를 돌려보냄.
  - 이 정보를 이용해서 경유한 라우터들의 목록을 만드는 것.
- nslookup
  - DNS 서버에 도메인에 대응하는 IP 어드레스를 물어보는 것.
  - `UnKnown` 응답은 질의 받은 DNS 서버가 자신의 도메인명 정보를 알려주지 않도록 설정됐을 때 표시.
  - `권한 없는 응답`은 DNS 컨텐츠 서버가 아닌 DNS 캐시 서버가 응답할 때 표시.
  - 도메인명으로 IP를 얻는 것을 정방향 조회<sup>forward DNS query</sup>,
  - 반대 방향을 역방향 조회<sup>reverse DNS query</sup>라고 부름.
  - 역방향 조회 시에는 `nslookup IP주소`를 입력하면 됨.
  - 도메인이 등록되지 않은 경우 역방향 조회 불가.
  - 메일 어드레스를 위한 MX 레코드도 존재. 이는 `nslookup -type=mx 도메인명` 식으로 질의.

# 하드웨어와 네트워크 인터페이스 계층

## 네트워크 인터페이스 계층 역할

- 네트워크의 하드웨어를 제어하는 부분.
- 네트워크 어댑터, LAN 케이블, 광 케이블 등이 하드웨어.
- 이런 하드웨어를 제어해서 인접한 통신기들에 데이터를 전달.
- 원거리 통신 경로를 거치는 인터넷 계층에 비해 오히려 짧은 구간을 다루는 것.
- 이 계층의 프로토콜로는 PPP, 이더넷, ARP 등이 있음.
  - ARP: IP를 이용해서 목적지 MAC을 알아냄.
  - PPP: 전화 회선을 사용해서 원격지와 접속.
  - 이더넷: 동축 케이블이나 UTP 케이블을 사용.

## MAC 어드레스

- 네트워크 어댑터(NIC<sup>Network Interface Card</sup>)에는 MAC<sup>Media Access Control</sup> 어드레스라는 식별 번호가 부여되어 있음.
- 이는 제조사가 제조 단계부터 붙이는 것이며 전 세계 네트워크 장비들을 서로 구분할 수 있는 값.
- 총 48비트에서 앞쪽 24비트는 제조사 식별 번호고 뒷쪽은 제조사에서 정의한 식별 번호.
- 유무선 LAN이나 블루투스 등 다양한 데이터 통신에 활용.
- 네트워크 인터페이스 계층이 보내는 데이터를 프레임이라 부르는데, 이 안에 송수신지의 MAC 어드레스가 담김.
- IP는 최종 목적지 도달까지 유지되지만, MAC은 전송 경로 중간 중간 다음 장비를 가리키는 값으로 계속 변경됨.

## 이더넷

- 유선 LAN은 통신 장비끼리 케이블을 연결하는데 이 때 이더넷<sup>Ethernet</sup>이라는 규격을 사용.
- 송신측은 비트의 0과 1을 전압의 높낮이로 표현하여 전달.
- 수신측은 이 전압의 높낮이를 0과 1의 디지털 신호로 복호화.
- 이 복호화 시에는 데이터가 어디부터 시작인지를 알아야 하는데,
- 이더넷 프레임의 앞부분에 프리앰블<sup>preamble</sup>이라는 패턴을 두어 시작 신호를 약속.
- 10101010...가 7바이트 이어진 후 마지막에 10101011이 나오는 식.
- 프리앰블의 길이는 상당히 길어서 앞부분의 데이터가 일부 손실되어도,
- 1010이 어느 정도 반복되다 마지막이 10101011로 끝나면 프레임 시작이라고 인식.
